<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: ext/stream.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: ext/stream.js</h1>

    


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var log = require("../lib/util/log")("Stream")
var lob = require('lob-enc');
var ChannelStream = require("./stream.class.js")

// implements https://github.com/telehash/telehash.org/blob/v3/v3/channels/stream.md
exports.name = 'stream';

exports.mesh = function(mesh, cbExt)
{
  var ext = {open:{}};

  /** attach an incoming stream handler to the mesh
   * @memberOf Mesh
   * @param {function} onStream - handler for incoming streams
   */
  mesh.stream = function(onStream)
  {
    mesh.log.debug('adding onStream handler',typeof onStream);
    ext.onStream = onStream;
  }

  /** takes any channel and returns a Duplex stream,
   * @memberOf Mesh
   * @param {Channel} channel - the channel to streamify
   * @param {string} encoding - 'binary' or 'json'
   * @return {ChannelStream}
   */
  mesh.streamize = function(chan, encoding)
  {
    return new ChannelStream(chan, encoding);
  }

  // new incoming stream open request
  ext.open.stream = function(args, open, cbOpen){
    var link = this;
    log.debug("got new incoming stream")
    if(typeof ext.onStream != 'function') return cbOpen('no stream');
    // pass any attached request packet as options, and a method to accept
    ext.onStream(link, lob.decode(open.body), function accept(err){
      if(err) return cbOpen(err);
      var channel = link.x.channel(open);
      channel.receive(open); // actually opens it
      return mesh.streamize(channel);
    });
  }

  ext.link = function(link, cbLink)
  {
    /** create a new stream to this link, and send the first packet
     * @memberOf TLink
     * @param {Buffer|object=} packet - binary/json packet body
     * @param {string} encoding - 'binary' or 'json'
     * @return {ChannelStream}
     */
    link.stream = function(packet, encoding)
    {
      var open = {json:{type:'stream'},body:packet};
      open.json.seq = 1; // always reliable
      var channel = link.x.channel(open);
      var stream = mesh.streamize(channel, encoding);
      channel.send(open);
      return stream;
    }

    cbLink();
  }

  cbExt(undefined, ext);
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Classes</h3><ul><li><a href="ChannelStream.html">ChannelStream</a></li><li><a href="Mesh.html">Mesh</a></li><li><a href="Pipe.html">Pipe</a></li><li><a href="TLink.html">TLink</a></li></ul><h3>Events</h3><ul><li><a href="Pipe.html#event:keepalive">keepalive</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha5</a> on Sat Aug 08 2015 17:33:47 GMT-0600 (MDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
